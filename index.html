<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chatz | Flakious</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #1e1e2f;
      color: #f5f5f5;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #2d2b45;
      padding: 1rem;
      text-align: center;
      font-weight: bold;
      position: relative;
    }
    #auth {
      position: absolute;
      right: 1rem;
      top: 1rem;
    }
    #chat-selector {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin: 0.5rem;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .message {
      background: #3a375a;
      padding: 0.5rem 1rem;
      border-radius: 1rem;
      max-width: 70%;
    }
    .own {
      background: #726dff;
      align-self: flex-end;
    }
    form {
      display: flex;
      gap: 0.5rem;
      padding: 1rem;
      background: #2d2b45;
    }
    input, select, button {
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 1rem;
      font-size: 1rem;
    }
    input, select {
      flex: 1;
      background: #44415e;
      color: white;
    }
    button {
      background: #726dff;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    Chatz
    <div id="auth">
      <button id="login">Sign In</button>
      <button id="logout" style="display:none;">Sign Out</button>
    </div>
  </header>

  <div id="chat-selector">
    <select id="chat-type">
      <option value="group">Group</option>
      <option value="dm">DM</option>
    </select>
    <select id="chat-target">
      <option value="general">general</option>
    </select>
  </div>

  <div id="chat"></div>

  <form id="chat-form">
    <input type="text" id="message" placeholder="Type a message..." required autocomplete="off" />
    <button type="submit">Send</button>
  </form>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      onChildAdded
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    const config = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_DOMAIN",
      databaseURL: "YOUR_DB_URL",
      projectId: "YOUR_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(config);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById("login");
    const logoutBtn = document.getElementById("logout");
    const chat = document.getElementById("chat");
    const form = document.getElementById("chat-form");
    const messageInput = document.getElementById("message");
    const chatType = document.getElementById("chat-type");
    const chatTarget = document.getElementById("chat-target");

    let currentUser = null;
    let currentPath = "group/general";

    const escapeHTML = str => str.replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;',
      '"': '&quot;', "'": '&#039;'
    })[m]);

    const loadChat = (path) => {
      chat.innerHTML = "";
      const chatRef = ref(db, `chats/${path}`);
      onChildAdded(chatRef, (snap) => {
        const { name, text, uid } = snap.val();
        const msg = document.createElement("div");
        msg.className = "message" + (uid === currentUser?.uid ? " own" : "");
        msg.textContent = `${name}: ${text}`;
        chat.appendChild(msg);
        chat.scrollTop = chat.scrollHeight;
      });
    };

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!currentUser) return;
      const text = messageInput.value.trim();
      if (!text) return;

      const path = `chats/${currentPath}`;
      push(ref(db, path), {
        name: currentUser.displayName,
        text: escapeHTML(text),
        uid: currentUser.uid,
        ts: Date.now()
      });
      messageInput.value = "";
    });

    chatType.addEventListener("change", () => {
      updateTargetOptions();
      updatePath();
    });

    chatTarget.addEventListener("change", updatePath);

    const updatePath = () => {
      const type = chatType.value;
      const target = chatTarget.value;
      currentPath = `${type}/${target}`;
      loadChat(currentPath);
    };

    const updateTargetOptions = () => {
      const type = chatType.value;
      chatTarget.innerHTML = "";

      if (type === "group") {
        ["general", "gaming", "school"].forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          chatTarget.appendChild(opt);
        });
      } else if (type === "dm" && currentUser) {
        fetchUsers().then(users => {
          users.forEach(user => {
            if (user.uid !== currentUser.uid) {
              const opt = document.createElement("option");
              opt.value = [currentUser.uid, user.uid].sort().join("_");
              opt.textContent = user.name;
              chatTarget.appendChild(opt);
            }
          });
        });
      }
    };

    const fetchUsers = async () => {
      const usersRef = ref(db, "users");
      const snap = await fetch(`${config.databaseURL}/users.json`);
      const data = await snap.json();
      return Object.values(data || {});
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline";
        messageInput.disabled = false;

        // Save user to users list
        push(ref(db, "users"), {
          uid: user.uid,
          name: user.displayName
        });

        updateTargetOptions();
        updatePath();
      } else {
        currentUser = null;
        loginBtn.style.display = "inline";
        logoutBtn.style.display = "none";
        messageInput.disabled = true;
        chat.innerHTML = "";
      }
    });

    loginBtn.onclick = () => signInWithPopup(auth, provider);
    logoutBtn.onclick = () => signOut(auth);
  </script>
</body>
</html>