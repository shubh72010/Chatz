<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flakious Chat | Reply & Responsive</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #1e1e2f;
    color: #f5f5f5;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: #302d4c;
    padding: 1rem;
    text-align: center;
    font-size: 1.6rem;
    font-weight: 700;
    user-select: none;
  }
  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }
  .message {
    background: #3a375a;
    border-radius: 1rem;
    max-width: 80%;
    padding: 0.6rem 1rem;
    word-wrap: break-word;
    position: relative;
  }
  .own {
    background: #5f5bc0;
    align-self: flex-end;
  }
  .meta {
    font-size: 0.7rem;
    opacity: 0.6;
    margin-top: 0.2rem;
  }
  .reply {
    font-size: 0.8rem;
    background: rgba(255 255 255 / 0.1);
    border-left: 3px solid #726dff;
    padding-left: 0.5rem;
    margin-bottom: 0.4rem;
    color: #ccc;
    cursor: pointer;
  }
  .reply:hover {
    color: #a0a0ff;
  }
  form {
    display: flex;
    flex-wrap: wrap;
    padding: 1rem;
    background: #2d2b45;
    gap: 0.5rem;
  }
  input[type="text"] {
    flex: 1 1 120px;
    padding: 0.6rem 1rem;
    border-radius: 1rem;
    border: none;
    outline: none;
    background: #44415e;
    color: white;
    font-size: 1rem;
  }
  button {
    padding: 0.6rem 1rem;
    border-radius: 1rem;
    border: none;
    background: #726dff;
    color: white;
    font-weight: 700;
    cursor: pointer;
    flex: 0 0 auto;
    font-size: 1rem;
  }
  button:hover {
    background: #5c58e0;
  }
  #reply-to {
    width: 100%;
    background: #48476a;
    border-radius: 1rem;
    padding: 0.4rem 1rem;
    color: #bbb;
    font-size: 0.85rem;
    display: none;
    user-select: none;
  }
  #reply-to span {
    font-weight: 700;
    color: #d0d0ff;
  }
  #reply-to button {
    background: transparent;
    color: #bbb;
    border: none;
    font-weight: 900;
    cursor: pointer;
    float: right;
    font-size: 1.2rem;
    padding: 0 0.4rem;
  }
  #reply-to button:hover {
    color: #f66;
  }

  /* Responsive tweaks */
  @media (max-width: 480px) {
    .message {
      max-width: 100%;
    }
    form {
      flex-direction: column;
    }
    input[type="text"] {
      flex: 1 1 auto;
      width: 100%;
    }
    button {
      width: 100%;
      margin-left: 0;
    }
  }
</style>
</head>
<body>
<header>Flakious Chat</header>
<div id="chat"></div>

<form id="chat-form" autocomplete="off">
  <input type="text" id="username" placeholder="Your name..." required />
  <div id="reply-to">
    Replying to <span id="reply-name"></span>: <span id="reply-msg"></span>
    <button type="button" id="cancel-reply" aria-label="Cancel reply">&times;</button>
  </div>
  <input type="text" id="message" placeholder="Type a message..." required />
  <button type="submit">Send</button>
</form>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import {
    getDatabase,
    ref,
    push,
    onChildAdded,
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAv4mVF8Y8lEKNK1vhBTy2Nj2Ya3l7ZJyQ",
    authDomain: "chatz-45df4.firebaseapp.com",
    databaseURL: "https://chatz-45df4-default-rtdb.firebaseio.com",
    projectId: "chatz-45df4",
    storageBucket: "chatz-45df4.appspot.com",
    messagingSenderId: "463847844545",
    appId: "1:463847844545:web:5006247d061c3e0dc28240",
    measurementId: "G-2VHETC9V8B"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const messagesRef = ref(db, "messages");

  const chat = document.getElementById("chat");
  const form = document.getElementById("chat-form");
  const nameInput = document.getElementById("username");
  const messageInput = document.getElementById("message");
  const replyToDiv = document.getElementById("reply-to");
  const replyNameSpan = document.getElementById("reply-name");
  const replyMsgSpan = document.getElementById("reply-msg");
  const cancelReplyBtn = document.getElementById("cancel-reply");

  // Store reply message id and data
  let replyTo = null;

  // Load saved username
  const savedName = localStorage.getItem("username");
  if (savedName) {
    nameInput.value = savedName;
  }

  // Save username on change
  nameInput.addEventListener("change", () => {
    localStorage.setItem("username", nameInput.value.trim());
  });

  // Sanitize text by escaping HTML special chars
  function sanitize(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  // Scroll chat to bottom
  function scrollToBottom() {
    chat.scrollTop = chat.scrollHeight;
  }

  // Render a message to the chat
  function renderMessage(data, key) {
    const msgDiv = document.createElement("div");
    msgDiv.className = "message";
    if (data.name === nameInput.value.trim()) {
      msgDiv.classList.add("own");
    }
    msgDiv.dataset.key = key;

    // If it's a reply, show the quoted message above
    if (data.replyTo && data.replyToMessage) {
      const replyDiv = document.createElement("div");
      replyDiv.className = "reply";
      replyDiv.textContent = `${data.replyTo}: ${data.replyToMessage}`;
      // Clicking on reply scrolls to original message
      replyDiv.onclick = () => {
        const original = chat.querySelector(`.message[data-key="${data.replyTo}"]`);
        if (original) {
          original.scrollIntoView({ behavior: "smooth", block: "center" });
          original.animate(
            [{ backgroundColor: "#726dff88" }, { backgroundColor: "transparent" }],
            { duration: 1000 }
          );
        }
      };
      msgDiv.appendChild(replyDiv);
    }

    const nameStrong = document.createElement("strong");
    nameStrong.textContent = data.name;
    msgDiv.appendChild(nameStrong);

    const msgText = document.createElement("span");
    msgText.textContent = `: ${data.message}`;
    msgDiv.appendChild(msgText);

    const metaDiv = document.createElement("div");
    metaDiv.className = "meta";
    const time = new Date(data.timestamp);
    metaDiv.textContent = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    msgDiv.appendChild(metaDiv);

    chat.appendChild(msgDiv);
  }

  // Listen for new messages
  onChildAdded(messagesRef, (snapshot) => {
    const data = snapshot.val();
    const key = snapshot.key;
    renderMessage(data, key);
    scrollToBottom();
  });

  // Handle reply cancel button
  cancelReplyBtn.onclick = () => {
    replyTo = null;
    replyToDiv.style.display = "none";
  };

  // Handle form submit
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const name = nameInput.value.trim();
    const message = messageInput.value.trim();
    if (!name || !message) return;

    // Prepare message payload
    const payload = {
      name,
      message,
      timestamp: Date.now(),
    };

    // If replying, add reply info
    if (replyTo) {
      payload.replyTo = replyTo.key;
      payload.replyToMessage = replyTo.message;
      payload.replyToName = replyTo.name;
    }

    // Push to Firebase
    push(messagesRef, payload).then(() => {
      messageInput.value = "";
      replyTo = null;
      replyToDiv.style.display = "none";
      messageInput.focus();
    }).catch((err) => {
      alert("Failed to send message. Try again.");
      console.error(err);
    });
  });

  // Add click handler to chat to enable reply on message click
  chat.addEventListener("click", (e) => {
    // Find the closest .message div
    const msgDiv = e.target.closest(".message");
    if (!msgDiv) return;

    // Get the key and message data
    const key = msgDiv.dataset.key;
    if (!key) return;

    // Prevent replying to your own message
    const author = msgDiv.querySelector("strong").textContent;
    if (author === nameInput.value.trim()) return;

    // Grab the message text (after the name and colon)
    const msgText = msgDiv.childNodes[1].textContent.slice(2); // skip ": "

    // Set replyTo info
    replyTo = { key, message: msgText, name: author };
    replyNameSpan.textContent = author;
    replyMsgSpan.textContent = msgText.length > 30 ? msgText.slice(0, 27) + "..." : msgText;
    replyToDiv.style.display = "block";

    // Focus the message input for quick reply
    messageInput.focus();
  });
</script>
</body>
</html>