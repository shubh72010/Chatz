<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chatz | Global Chat</title>
  <script>
    (function() {
      // Initially set to default theme. JavaScript will update this on auth state change.
      document.documentElement.className = 'theme-default';
    })();
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/391827d54c.js" crossorigin="anonymous"></script>
  <style>
    /* Base variables (consistent with index.html) */
    :root {
      --main: #a259ff; /* Primary accent color (purple) */
      --accent: #5f27cd; /* Darker accent color */
      --danger: #ff5252; /* Red for danger/errors */
      /* Default theme specific colors (will be overridden by theme classes) */
      --header-bg: rgba(44,32,69,0.96);
      --body-bg: linear-gradient(135deg, #a259ff 0%, #5f27cd 100%);
      --chat-bubble-bg: #191938;
      --chat-bubble-user-bg: #4b0082; /* Darker purple for user's own bubbles */
      --input-bg: rgba(255,255,255,0.16);
      --text-color: #f0eaff;
      --border-color: #a259ff33;
      --timestamp-color: #f0eaffb3;
      --button-bg: #a259ff;
      --button-hover-bg: #5f27cd;
    }

    /* Default Theme */
    .theme-default {
      --header-bg: rgba(44,32,69,0.96);
      --body-bg: linear-gradient(135deg, #a259ff 0%, #5f27cd 100%);
      --chat-bubble-bg: #191938;
      --chat-bubble-user-bg: #4b0082;
      --input-bg: rgba(255,255,255,0.16);
      --text-color: #f0eaff;
      --border-color: #a259ff33;
      --timestamp-color: #f0eaffb3;
      --button-bg: #a259ff;
      --button-hover-bg: #5f27cd;
    }

    /* Dark Theme (Enhanced Darker) */
    .theme-dark {
      --header-bg: #1a1a1a;
      --body-bg: #0d0d0d;
      --chat-bubble-bg: #1a1a1a;
      --chat-bubble-user-bg: #330066; /* Darker purple for user's own bubbles in dark mode */
      --input-bg: #2c2c2c;
      --text-color: #ffffff;
      --border-color: rgba(255, 255, 255, 0.05);
      --timestamp-color: #ffffffb3;
      --button-bg: #a259ff;
      --button-hover-bg: #5f27cd;
    }

    /* Light Theme (Enhanced Lighter) */
    .theme-light {
      --header-bg: #ffffff;
      --body-bg: #f8f8f8;
      --chat-bubble-bg: #ffffff;
      --chat-bubble-user-bg: #e0ccff; /* Lighter purple for user's own bubbles in light mode */
      --input-bg: #f0f0f0;
      --text-color: #1a1a1a;
      --border-color: rgba(0, 0, 0, 0.1);
      --timestamp-color: #1a1a1ab3;
      --button-bg: #a259ff;
      --button-hover-bg: #5f27cd;
    }

    /* General Styling */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      font-family: 'Poppins', sans-serif;
      background: var(--body-bg);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 800px; /* Constrain width for better readability */
      margin: 0 auto;
      width: 100%;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    .right-header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between; /* Adjusted to spread items */
      padding: 0.8rem 1.2rem;
      background: var(--header-bg);
      color: var(--text-color); /* Themed header text */
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 20;
      flex-shrink: 0;
      min-height: 70px;
      transition: background 0.3s, color 0.3s;
    }
    .right-header .back-btn {
      background: none;
      border: none;
      color: var(--text-color); /* Themed */
      font-size: 1.8rem;
      cursor: pointer;
      padding: 0 0.5rem;
      transition: color 0.2s;
    }
    .right-header .back-btn:hover { color: var(--main);}
    .right-header .header-user-info {
      display: flex;
      align-items: center;
      flex-grow: 1; /* Allows it to take available space */
      gap: 0.8rem;
      margin-left: 1rem; /* Space from back button */
    }
    .right-header .user-img { width: 42px; height: 42px; border-radius: 50%; overflow: hidden;}
    .right-header .user-img img { width: 42px; height: 42px; object-fit: cover; border-radius: 50%; border: 2px solid var(--main); background: #fff;}
    .right-header #header-display-name {
      color: var(--text-color); /* Themed */
      font-size: 1.2rem;
      font-weight: 600;
      max-width: 250px; /* Limit width to prevent overflow */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: color 0.3s;
    }
    .right-header .settings-btn {
      background: var(--button-bg); /* Themed */
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px rgba(162,89,255,0.2);
      margin-left: 1rem; /* Space from theme switcher */
    }
    .right-header .settings-btn:hover { background: var(--button-hover-bg);}

    /* Theme switcher dropdown in header */
    #theme-switcher {
      padding: 0.3rem;
      border-radius: 5px;
      background: var(--input-bg); /* Themed */
      color: var(--text-color); /* Themed */
      border: 1px solid var(--button-bg); /* Themed border */
      font-size: 0.9rem;
      cursor: pointer;
      appearance: none; /* Remove default dropdown arrow */
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 0.7em auto;
      padding-right: 2rem; /* Make space for arrow */
      margin-left: auto; /* Push it to the right */
      transition: background 0.3s, color 0.3s, border 0.3s;
    }
    #theme-switcher option {
        background: var(--input-bg); /* Themed */
        color: var(--text-color); /* Themed */
    }

    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
      background: var(--body-bg); /* Themed */
      min-height: 0;
      min-width: 0;
      transition: background 0.3s;
    }
    .message-bubble {
      display: flex;
      flex-direction: column;
      max-width: 70%;
      word-wrap: break-word;
      line-height: 1.4;
    }
    .message-content {
      padding: 0.6rem 0.9rem;
      border-radius: 0.7rem;
      font-size: 0.95rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .message-meta {
      font-size: 0.75rem;
      color: var(--timestamp-color); /* Themed */
      margin-top: 0.2rem;
      opacity: 0.9;
      transition: color 0.3s;
    }
    .other-message .message-content {
      background: var(--chat-bubble-bg); /* Themed */
      color: var(--text-color); /* Themed */
      border-bottom-left-radius: 0.2rem;
      transition: background 0.3s, color 0.3s;
    }
    .other-message {
      align-self: flex-start;
    }
    .other-message .message-meta {
      text-align: left;
    }
    .my-message {
      align-self: flex-end;
    }
    .my-message .message-content {
      background: var(--chat-bubble-user-bg); /* Themed */
      color: #fff; /* White text for user's own bubbles */
      border-bottom-right-radius: 0.2rem;
      transition: background 0.3s;
    }
    .my-message .message-meta {
      text-align: right;
    }
    .chat-input-container {
      display: flex;
      padding: 0.8rem 1rem;
      background: var(--header-bg); /* Themed */
      border-top: 1px solid var(--border-color); /* Themed */
      gap: 0.8rem;
      flex-shrink: 0;
      transition: background 0.3s, border-color 0.3s;
    }
    .chat-input-container textarea {
      flex: 1;
      padding: 0.7rem 1rem;
      border-radius: 1.5rem;
      border: 1px solid var(--button-bg); /* Themed */
      background: var(--input-bg); /* Themed */
      color: var(--text-color); /* Themed */
      font-size: 1rem;
      resize: none;
      outline: none;
      height: 44px; /* Fixed height to prevent excessive resizing */
      overflow-y: hidden; /* Hide scrollbar until needed */
      transition: background 0.3s, color 0.3s, border 0.3s;
    }
    .chat-input-container textarea::placeholder {
      color: var(--text-color);
      opacity: 0.7;
    }
    .chat-input-container button {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: var(--button-bg); /* Themed */
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px rgba(162,89,255,0.2);
    }
    .chat-input-container button:hover { background: var(--button-hover-bg);}
    .empty-chat-message {
      text-align: center;
      color: var(--text-color);
      opacity: 0.7;
      margin-top: 2rem;
    }
    @media (max-width: 600px) {
      .chat-container {
        border-radius: 0;
      }
      .right-header {
        padding: 0.6rem 0.8rem;
        min-height: 60px;
      }
      .right-header .back-btn { font-size: 1.5rem; }
      .right-header .user-img { width: 36px; height: 36px;}
      .right-header .user-img img { width: 36px; height: 36px;}
      .right-header #header-display-name { font-size: 1rem; max-width: 150px;}
      .right-header .settings-btn { width: 36px; height: 36px; font-size: 1.1rem;}
      #theme-switcher { font-size: 0.8rem; padding: 0.2rem 1.5rem 0.2rem 0.5rem; background-position: right 0.2rem center;}
      .chat-area { padding: 0.7rem; gap: 0.5rem;}
      .message-bubble { max-width: 85%;}
      .message-content { font-size: 0.9rem; padding: 0.5rem 0.8rem;}
      .message-meta { font-size: 0.7rem;}
      .chat-input-container { padding: 0.6rem 0.8rem; gap: 0.6rem;}
      .chat-input-container textarea { padding: 0.6rem 0.8rem; font-size: 0.9rem; height: 40px;}
      .chat-input-container button { width: 40px; height: 40px; font-size: 1rem;}
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="right-header">
      <button class="back-btn" onclick="history.back()" title="Go back">&#8592;</button>
      <div class="header-user-info">
        <div class="user-img"><img id="header-pfp" src="https://via.placeholder.com/38/2c2045/f0eaff?text=?" alt="User PFP"/></div>
        <span id="header-display-name">Global Chat</span>
      </div>
      <select id="theme-switcher" style="display:none;">
        <option value="default">Default</option>
        <option value="dark">Dark</option>
        <option value="light">Light</option>
      </select>
      <button class="settings-btn" onclick="window.location.href='settings.html'" title="Settings">⚙️</button>
    </div>

    <div class="chat-area" id="chat-messages">
      <div class="empty-chat-message" id="empty-chat-message">
        No messages yet. Be the first to say something!
      </div>
    </div>

    <div class="chat-input-container">
      <textarea id="message-input" placeholder="Type a message..."></textarea>
      <button id="send-button"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { getDatabase, ref, push, onChildAdded, serverTimestamp, query, limitToLast } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAv4mVF8Y8lEKNK1vhBTy2Nj2Ya3l7ZJyQ",
      authDomain: "chatz-45df4.firebaseapp.com",
      databaseURL: "https://chatz-45df4-default-rtdb.firebaseio.com",
      projectId: "chatz-45df4",
      storageBucket: "chatz-45df4.appspot.com",
      messagingSenderId: "463847844545",
      appId: "1:463847844545:web:5006247d061c3e0dc28240"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const chatMessages = document.getElementById('chat-messages');
    const emptyChatMessage = document.getElementById('empty-chat-message');
    const headerPfp = document.getElementById('header-pfp');
    const headerDisplayName = document.getElementById('header-display-name');
    const themeSwitcher = document.getElementById('theme-switcher'); // Get the theme switcher element

    let currentUser = null;
    let chatRef = null;
    let chatType = 'global'; // 'global' or 'dm'
    let targetUid = null; // For DM chat

    // --- Theme Switching Logic ---
    function applyTheme(themeName) {
      document.documentElement.className = 'theme-' + themeName;
      localStorage.setItem('chatzTheme', themeName);

      // Dynamically update the dropdown arrow color based on the current theme's text color
      const computedStyle = getComputedStyle(document.documentElement);
      const textColor = computedStyle.getPropertyValue('--text-color').trim();
      const encodedTextColor = encodeURIComponent(textColor);

      const svgArrow = `url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22${encodedTextColor}%22%20d%3D%22M287%2C114.7L159.2%2C242.5c-4.5%2C4.5-10.6%2C6.8-16.8%2C6.8s-12.3-2.3-16.8-6.8L5.4%2C114.7c-9.1-9.1-9.1-23.7%2C0-32.8s23.7-9.1%2C32.8%2C0l118%2C118l118-118c9.1-9.1%2C23.7-9.1%2C32.8%2C0S296.1%2C105.6%2C287%2C114.7z%22%2F%3E%3C%2Fsvg%3E')`;
      themeSwitcher.style.backgroundImage = svgArrow;
    }

    // Event listener for theme switcher
    themeSwitcher.addEventListener('change', (event) => {
      applyTheme(event.target.value);
    });
    // --- End Theme Switching Logic ---

    // Function to parse URL parameters
    function getUrlParams() {
      const params = {};
      window.location.search.substring(1).split("&").forEach(param => {
        const parts = param.split("=");
        params[parts[0]] = decodeURIComponent(parts[1]);
      });
      return params;
    }

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      const params = getUrlParams();
      chatType = params.type || 'global';
      targetUid = params.uid || null;

      // Conditional display of theme switcher
      if (currentUser) {
        themeSwitcher.style.display = "inline-block";
        const storedTheme = localStorage.getItem('chatzTheme') || 'default';
        applyTheme(storedTheme);
        themeSwitcher.value = storedTheme; // Set dropdown to current theme
      } else {
        themeSwitcher.style.display = "none";
        applyTheme('default'); // Force default theme if not signed in
        themeSwitcher.value = 'default';
        // Redirect to index.html if not signed in and trying to access DM
        if (chatType === 'dm') {
          alert('You must be signed in to access private chats.');
          window.location.href = 'index.html';
          return;
        }
      }

      setupChat();
    });

    function setupChat() {
      if (chatType === 'global') {
        chatRef = ref(db, 'globalChat');
        headerDisplayName.textContent = 'Global Chat';
        headerPfp.src = "https://via.placeholder.com/38/2c2045/f0eaff?text=?"; // Default for global chat
        headerPfp.style.display = 'none'; // Hide pfp for global chat
      } else if (chatType === 'dm' && currentUser && targetUid) {
        // Construct DM path for both users to access
        const dmPath = currentUser.uid < targetUid ? `${currentUser.uid}-${targetUid}` : `${targetUid}-${currentUser.uid}`;
        chatRef = ref(db, `dms/${dmPath}`);

        // Fetch target user's info for header
        onValue(ref(db, `users/${targetUid}`), (snapshot) => {
          const targetUser = snapshot.val();
          if (targetUser) {
            headerDisplayName.textContent = targetUser.displayName || targetUser.nickname || 'Unknown User';
            headerPfp.src = targetUser.photoURL || "https://via.placeholder.com/38/2c2045/f0eaff?text=U";
            headerPfp.style.display = 'block'; // Show pfp for DM
          } else {
            headerDisplayName.textContent = 'DM Chat';
            headerPfp.src = "https://via.placeholder.com/38/2c2045/f0eaff?text=U";
            headerPfp.style.display = 'block';
          }
        }, { onlyOnce: true }); // Only fetch once for header info

      } else {
        // Invalid state, redirect to index
        window.location.href = 'index.html';
        return;
      }

      chatMessages.innerHTML = ''; // Clear existing messages
      emptyChatMessage.style.display = 'block'; // Show empty message placeholder initially

      // Load last 50 messages
      onChildAdded(query(chatRef, limitToLast(50)), (data) => {
        emptyChatMessage.style.display = 'none'; // Hide empty message placeholder
        const message = data.val();
        displayMessage(message);
      });
    }

    sendButton.onclick = () => {
      if (!currentUser) {
        alert("You must be signed in to send messages.");
        return;
      }
      const messageText = messageInput.value.trim();
      if (messageText) {
        const messageData = {
          uid: currentUser.uid,
          displayName: currentUser.displayName,
          photoURL: currentUser.photoURL,
          text: messageText,
          timestamp: serverTimestamp()
        };
        push(chatRef, messageData);
        messageInput.value = '';
        chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to bottom
      }
    };

    messageInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault(); // Prevent new line
        sendButton.click();
      }
    });

    function displayMessage(message) {
      const messageElement = document.createElement('div');
      messageElement.className = `message-bubble ${message.uid === currentUser?.uid ? 'my-message' : 'other-message'}`;

      const timestamp = message.timestamp ? new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Sending...';
      const senderDisplayName = message.displayName || 'Anonymous';
      const senderPfp = message.photoURL || "https://via.placeholder.com/24/5f27cd/f0eaff?text=U"; // Default PFP for sender

      let senderInfo = '';
      if (message.uid !== currentUser?.uid) { // Show sender's name and PFP for others' messages
          senderInfo = `
              <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.2rem;">
                  <img src="${senderPfp}" alt="PFP" style="width:24px; height:24px; border-radius:50%; border:1px solid var(--main);">
                  <span style="font-size:0.85rem; font-weight:600; color:var(--main);">${senderDisplayName}</span>
              </div>
          `;
      }

      messageElement.innerHTML = `
          ${senderInfo}
          <div class="message-content">${message.text}</div>
          <div class="message-meta">${timestamp}</div>
      `;
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Adjust textarea height
    messageInput.addEventListener('input', () => {
      messageInput.style.height = 'auto'; // Reset height
      messageInput.style.height = (messageInput.scrollHeight) + 'px'; // Set to scroll height
    });
  </script>
</body>
</html>
